<odoo>

    <!-- <record id="paperformat_report_monthly_expenditure" model="report.paperformat">
      <field name="name">Monthly Expenditure Report Format</field>
      <field name="default" eval="True"/>
      <field name="format">A4</field>
      <field name="page_height">0</field>
      <field name="page_width">0</field>
      <field name="orientation">Portrait</field>
      <field name="margin_top">15</field>
      <field name="margin_bottom">15</field>
      <field name="margin_left">10</field>
      <field name="margin_right">10</field>
      <field name="header_line" eval="False"/>
      <field name="header_spacing">0</field>
      <field name="dpi">96</field>
    </record> -->
    

    <template id="report_expenditure_monthly_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-foreach="data" t-as="report">
                    <div class="page">
                        <div class="text-left mb-4">
                            <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">
                                <t t-esc="report.get('title')"/>
                            </h3>
                            <h4 style="font-size: 14px; font-weight: bold; margin-top: 0;">
                                <t t-esc="subtitle"/>
                            </h4>
                        </div>
                        
                        <style>
                            .report-table { border-collapse: collapse; width: 100%; font-size: 10px; }
                            .report-table th, .report-table td { border: 1px solid #000; padding: 4px 6px; vertical-align: middle; }
                            .report-table th { background-color: #e6e6e6; font-weight: bold; text-align: center; }
                            .text-right { text-align: right !important; }
                            .text-center { text-align: center !important; }
                            .text-left { text-align: left !important; }
                            .parent-level { background-color: #f8f8f8; }
                            .account-row { font-style: italic; }
                        </style>

                        <table class="report-table mt-3">
                            <thead>
                                <tr>
                                    <th style="width: 12%; text-align: center;">Sub-Head</th>
                                    <th style="width: 35%; text-align: left;">Description</th>
                                    <th style="width: 15%; text-align: right;">Previous<br/>Actual</th>
                                    <t t-if="len(month_headers) == 1">
                                        <th style="width: 18%; text-align: right;">
                                            Exp. for the<br/>Month of <t t-esc="month_headers[0].capitalize()"/>
                                        </th>
                                    </t>
                                    <t t-else="">
                                        <t t-foreach="month_headers" t-as="month">
                                            <th style="width: 12%; text-align: right;"><t t-esc="month"/></th>
                                        </t>
                                    </t>
                                    <th style="width: 20%; text-align: right;">Total Actual<br/>Exp. to Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="report.get('report_lines')" t-as="line">
                                    <t t-set="is_account" t-value="line.get('is_acc') == 'yes'"/>
                                    <t t-set="is_parent" t-value="line.get('level', 0) == 0"/>
                                    
                                    <tr t-att-class="'parent-level' if is_parent else ''" t-att-style="'font-weight: bold;' if is_account else ''">
                                        
                                        <td class="text-center">
                                            <span t-esc="line.get('code', '')"/>
                                        </td>
                                        <td class="text-left">
                                            <span t-esc="line.get('name', '')" t-att-class="'account-row' if is_account else ''"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(line.get('previous_actual', 0.0))"/>
                                        </td>
                                        <t t-foreach="month_headers" t-as="month">
                                            <td class="text-right">
                                                <span t-esc="'{:,.2f}'.format(line.get('monthly_values', {}).get(month, 0.0))"/>
                                            </td>
                                        </t>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(line.get('total_exp_to_date', 0.0))"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                        
                        <div class="mt-4 text-right" style="font-size: 10px; color: #666;">
                            <p>Report generated on: <span t-esc="datetime.datetime.now().strftime('%B %d, %Y')"/></p>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
    

    <template id="report_expenditure_quarterly_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-foreach="data" t-as="report">
                    <div class="page">
                        <div class="text-left mb-4">
                            <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">
                                <t t-esc="report.get('title')"/>
                            </h3>
                            <h4 style="font-size: 14px; font-weight: bold; margin-top: 0;">
                                <t t-esc="subtitle"/>
                            </h4>
                        </div>
                        
                        <style>
                            .report-table { border-collapse: collapse; width: 100%; font-size: 9px; }
                            .report-table th, .report-table td { border: 1px solid #000; padding: 4px; vertical-align: middle; }
                            .report-table th { background-color: #e6e6e6; font-weight: bold; text-align: center; }
                            .text-right { text-align: right !important; }
                            .text-center { text-align: center !important; }
                            .text-left { text-align: left !important; }
                            .account-row { font-style: italic; }
                        </style>

                        <table class="report-table mt-3">
                            <thead>
                                <tr>
                                    <th style="width: 12%;">Sub-Head</th>
                                    <th style="width: 35%;">Description</th>
                                    <t t-foreach="month_headers" t-as="month">
                                        <th style="width: 15%;" class="text-right"><t t-esc="month"/></th>
                                    </t>
                                    <th style="width: 18%;" class="text-right">
                                        <t t-if="quarterly_total_header">
                                            <t t-esc="quarterly_total_header"/>
                                        </t>
                                        <t t-else="">
                                            Total
                                        </t>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="report.get('report_lines')" t-as="line">
                                    <t t-set="is_account" t-value="line.get('is_acc') == 'yes'"/>
                                    <tr t-att-style="'font-weight: bold;' if is_account else ''">
                                        <td class="text-center"><span t-esc="line.get('code', '')"/></td>
                                        
                                        <td class="text-left">
                                            <span t-esc="line.get('name', '')" t-att-class="'account-row' if is_account else ''"/>
                                        </td>
                                        
                                        <t t-foreach="month_headers" t-as="month">
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(line.get('monthly_values', {}).get(month, 0.0))"/>
                                        </td>
                                    </t>
                                    
                                    <td class="text-right">
                                        <span t-esc="'{:,.2f}'.format(line.get('quarterly_total', 0.0) if line.get('quarterly_total') else line.get('total_exp_to_date', 0.0))"/>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
            </t>
        </t>
    </t>
</template>

    <template id="report_total_monthly_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-foreach="data" t-as="report">
                    <div class="page">
                        <div class="text-left mb-4">
                            <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;"><t t-esc="report.get('title')"/></h3>
                            <h4 style="font-size: 14px; font-weight: bold; margin-top: 0;"><t t-esc="subtitle"/></h4>
                        </div>
                        <style>.report-table { border-collapse: collapse; width: 100%; font-size: 9px; } .report-table th, .report-table td { border: 1px solid #000; padding: 4px; vertical-align: middle; } .report-table th { background-color: #e6e6e6; font-weight: bold; text-align: center; } .text-right { text-align: right !important; } .capital-header { background-color: #f2f2f2; font-weight: bold; text-align:center; }</style>
                        <table class="report-table mt-3">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">CODE</th>
                                    <th style="width: 20%;">DESCRIPTION</th>
                                    <t t-foreach="district_headers" t-as="district"><th style="width: 13%;" class="text-right"><t t-esc="district"/> DISTRICT</th></t>
                                    <th style="width: 13%;" class="text-right">TOTAL REV.</th>
                                    <th style="width: 13%;" class="text-right">TOTAL EXP.</th>
                                    <th style="width: 13%;" class="text-right">BALANCE</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="report.get('report_lines')" t-as="line">
                                    <tr>
                                        <td><span t-esc="line.get('code', '')"/></td>
                                        <td><span t-esc="line.get('description', '')"/></td>
                                        <t t-foreach="month_headers" t-as="month"><td class="text-right"><span t-esc="'{:,.2f}'.format(line.get('district_values', {}).get(district, 0.0))"/></td></t>
                                        <td class="text-right"><span t-esc="'{:,.2f}'.format(line.get('total_exp_to_date', 0.0))"/></td>
                                        <td class="text-right"><span t-esc="'{:,.2f}'.format(line.get('balance', 0.0))"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>
            </t>
        </t>
    </template>

    <template id="report_total_quarterly_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-foreach="data" t-as="report">
                    <div class="page">
                        <div class="text-left mb-4">
                            <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;"><t t-esc="report.get('title')"/></h3>
                            <h4 style="font-size: 14px; font-weight: bold; margin-top: 0;"><t t-esc="subtitle"/></h4>
                        </div>
                        <style>.report-table { border-collapse: collapse; width: 100%; font-size: 9px; } .report-table th, .report-table td { border: 1px solid #000; padding: 4px; vertical-align: middle; } .report-table th { background-color: #e6e6e6; font-weight: bold; text-align: center; } .text-right { text-align: right !important; } .text-center { text-align: center !important; } .capital-header { background-color: #f2f2f2; font-weight: bold; text-align:center; }</style>
                        <table class="report-table mt-3">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Code</th>
                                    <th style="width: 20%;">DESCRIPTION</th>
                                    <t t-foreach="district_headers" t-as="district"><th style="width: 9%;" class="text-right"><t t-esc="district"/></th></t>
                                    <th style="width: 10%;" class="text-right"><t t-esc="quarterly_total_header"/></th>
                                    <th style="width: 7%;">% PERF TO DATE</th>
                                    <th style="width: 11%;" class="text-right">BALANCE</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="report.get('report_lines')" t-as="line">
                                    <tr>
                                        <td><span t-esc="line.get('code', '')"/></td>
                                        <td><span t-esc="line.get('description', '')"/></td>
                                        <t t-foreach="month_headers" t-as="month"><td class="text-right"><span t-esc="'{:,.2f}'.format(line.get('district_values', {}).get(district, 0.0))"/></td></t>
                                        <td class="text-right"><span t-esc="'{:,.2f}'.format(line.get('quarterly_total', 0.0))"/></td>
                                        <td class="text-center"><span t-esc="'{:.2f}%'.format(line.get('percentage_perf', 0.0))"/></td>
                                        <td class="text-right"><span t-esc="'{:,.2f}'.format(line.get('balance', 0.0))"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>
            </t>
        </t>
    </template>

    
    
    <template id="consolidated_district_report_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">

                <div class="d-print-none" style="background:#f8f9fa; padding:10px; margin-bottom:10px; border:1px solid #dee2e6;">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="rpt_date_from">Date From:</label>
                            <input type="date" id="rpt_date_from" class="form-control form-control-sm" t-att-value="current_date_from or ''"/>
                        </div>
                        <div class="col-md-3">
                            <label for="rpt_date_to">Date To:</label>
                            <input type="date" id="rpt_date_to" class="form-control form-control-sm" t-att-value="current_date_to or ''"/>
                        </div>
                        <div class="col-md-3">
                            <label for="rpt_account_head_type">Account Type:</label>
                            <select id="rpt_account_head_type" class="form-control form-control-sm">
                                <t t-foreach="account_head_types or []" t-as="aht">
                                    <option t-att-value="aht[0]" t-att-selected="'selected' if (current_account_head_type and aht[0] == current_account_head_type) else None">
                                        <t t-esc="aht[1]"/>
                                    </option>
                                </t>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button id="rpt_apply_btn" class="btn btn-primary btn-sm mr-2" t-att-data-wizard-id="wizard_id or ''">Apply Filters</button>
                            <div id="rpt_loading" style="display:none;"><i class="fa fa-spinner fa-spin"></i> Updating...</div>
                        </div>
                    </div>
                </div>

                <t t-foreach="data or []" t-as="report">
                    <div class="page" style="margin-bottom: 20px;">

                        <div class="text-center mb-4">
                            <h2 style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">
                                <t t-esc="report.get('company_name', 'EEDC')"/>
                            </h2>
                            <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">
                                CONSOLIDATED DISTRICT REPORT
                            </h3>
                            <h4 style="font-size: 12px; font-weight: bold; margin-top: 0;">
                                <t t-esc="report.get('subtitle','')"/>
                            </h4>
                        </div>

                        <style>
                            .consolidated-table { border-collapse: collapse; width: 100%; font-size: 10px; margin-top: 20px; }
                            .consolidated-table th, .consolidated-table td { border: 1px solid #000; padding: 6px; vertical-align: middle; }
                            .consolidated-table th { background-color: #e6e6e6; font-weight: bold; text-align: center; font-size: 9px; }
                            .text-right { text-align: right !important; }
                            .text-center { text-align: center !important; }
                            .expandable-row { cursor: pointer; background-color: #f8f9fa; font-weight: bold; }
                            .expandable-row:hover { background-color: #e9ecef; }
                            .move-detail-row { display: none; background-color: #fff; font-size: 9px; font-weight: normal; }
                            .move-detail-row.show { display: table-row; }
                            .expand-icon { font-weight: bold; font-size: 12px; margin-right: 5px; color: #007bff; display:inline-block; transition: transform 0.2s; }
                            .expand-icon.expanded { transform: rotate(90deg); }
                            .indent-move { padding-left: 30px; font-style: italic; color: #666; }
                            .total-row { background-color: #d4edda; font-weight: bold; border-top: 2px solid #000; }
                            .account-code { font-family: 'Courier New', monospace; font-weight: bold; }
                            .move-reference { font-size: 8px; color: #666; }
                        </style>

                        <script type="text/javascript"><![CDATA[
                            document.addEventListener('DOMContentLoaded', function() {
                                // existing toggle function (keeps current behaviour)
                                window.toggleAccountDetails = function(accountCode) {
                                    try {
                                        var detailRows = document.querySelectorAll('.moves-' + accountCode);
                                        var icon = document.getElementById('icon-' + accountCode);
                                        if (!detailRows.length || !icon) return;
                                        var isVisible = detailRows[0].classList.contains('show');
                                        detailRows.forEach(function(row) {
                                            if (isVisible) { row.classList.remove('show'); }
                                            else { row.classList.add('show'); }
                                        });
                                        if (isVisible) { icon.classList.remove('expanded'); }
                                        else { icon.classList.add('expanded'); }
                                    } catch (err) {
                                        console.error('toggleAccountDetails error', err);
                                    }
                                };

                                // --------------------------
                                // Date-range shortcut logic
                                // --------------------------
                                function jsonRpcCall(model, method, args, kwargs) {
                                    var payload = {
                                        jsonrpc: "2.0",
                                        method: "call",
                                        params: {
                                            model: model,
                                            method: method,
                                            args: args || [],
                                            kwargs: kwargs || {}
                                        },
                                        id: new Date().getTime()
                                    };
                                    return fetch('/web/dataset/call_kw/' + model + '/' + method, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        credentials: 'same-origin',
                                        body: JSON.stringify(payload)
                                    }).then(function (r) { return r.json(); });
                                }

                                function showLoading(flag) {
                                    var spinner = document.getElementById('rpt_loading');
                                    var btn = document.getElementById('rpt_apply_btn');
                                    if (!spinner || !btn) return;
                                    if (flag) {
                                        spinner.style.display = '';
                                        btn.disabled = true;
                                    } else {
                                        spinner.style.display = 'none';
                                        btn.disabled = false;
                                    }
                                }

                                function applyDateFilters() {
                                    try {
                                        var btn = document.getElementById('rpt_apply_btn');
                                        if (!btn) return;
                                        var wizardId = btn.dataset.wizardId || btn.getAttribute('data-wizard-id');
                                        if (!wizardId) {
                                            console.warn('No wizard id found on Apply button - cannot update params.');
                                            return;
                                        }
                                        var dateFrom = (document.getElementById('rpt_date_from') || {}).value || false;
                                        var dateTo = (document.getElementById('rpt_date_to') || {}).value || false;

                                        // nothing to do if both empty
                                        if (!dateFrom && !dateTo) {
                                            // still reload to reflect possible other changes (optional)
                                            return;
                                        }

                                        showLoading(true);
                                        // call model method: update_report_params(wizard_id, **kwargs)
                                        jsonRpcCall('account.dynamic.report', 'update_report_params', [wizardId], {date_from: dateFrom || false, date_to: dateTo || false})
                                            .then(function (resp) {
                                                showLoading(false);
                                                if (resp && resp.result && resp.result.success) {
                                                    // reload page so report re-renders with new wizard params
                                                    window.location.reload();
                                                } else {
                                                    // graceful error display
                                                    var err = (resp && resp.error && resp.error.message) ? resp.error.message : 'Failed to update report parameters';
                                                    console.error('update_report_params error:', resp);
                                                    alert('Could not update report parameters:\\n' + err);
                                                }
                                            })
                                            .catch(function (err) {
                                                showLoading(false);
                                                console.error('RPC error', err);
                                                alert('Could not update report parameters (network or server error). See console for details.');
                                            });
                                            
                                            // --- populate inputs from wizard record if empty ---
                                            function loadWizardParamsIntoForm() {
                                                try {
                                                    var btn = document.getElementById('rpt_apply_btn');
                                                    if (!btn) return;
                                                    var wizardId = btn.dataset.wizardId || btn.getAttribute('data-wizard-id');
                                                    if (!wizardId) return;

                                                    // If fields are already non-empty, skip (prevents overwriting)
                                                    var df = document.getElementById('rpt_date_from');
                                                    var dt = document.getElementById('rpt_date_to');
                                                    var sel = document.getElementById('rpt_account_head_type');
                                                    var needLoad = !( (df && df.value) || (dt && dt.value) || (sel && sel.value) );

                                                    if (!needLoad) return;

                                                    // Read the wizard record (returns list of dicts)
                                                    jsonRpcCall('account.dynamic.report', 'read', [[parseInt(wizardId, 10)], ['date_from','date_to','account_head_type']], {})
                                                        .then(function(resp){
                                                            if (!resp || !resp.result) return;
                                                            var rows = resp.result;
                                                            if (!rows || !rows.length) return;
                                                            var vals = rows[0] || {};

                                                            if (df && vals.date_from) df.value = vals.date_from;
                                                            if (dt && vals.date_to) dt.value = vals.date_to;

                                                            if (sel && vals.account_head_type) {
                                                                // attempt to select matching option value
                                                                var opt = Array.prototype.slice.call(sel.options).find(function(o){ return o.value == vals.account_head_type; });
                                                                if (opt) sel.value = opt.value;
                                                            }
                                                        })
                                                        .catch(function(err){
                                                            // non-fatal: leave inputs blank and let user type
                                                            console.warn('Could not load wizard params for report filters', err);
                                                        });
                                                } catch (e) {
                                                    console.error('loadWizardParamsIntoForm error', e);
                                                }
                                            }

                                            // call it once on load (after jsonRpcCall defined)
                                            loadWizardParamsIntoForm();

                                    } catch (err) {
                                        console.error('applyDateFilters error', err);
                                    }
                                }

                                // wire up Apply button and Enter key on inputs
                                var applyBtn = document.getElementById('rpt_apply_btn');
                                if (applyBtn) {
                                    applyBtn.addEventListener('click', function (ev) {
                                        ev.preventDefault();
                                        applyDateFilters();
                                    });
                                }
                                // allow pressing Enter in either date box to apply quickly
                                var dfrom = document.getElementById('rpt_date_from');
                                var dto = document.getElementById('rpt_date_to');
                                [dfrom, dto].forEach(function(el) {
                                    if (!el) return;
                                    el.addEventListener('keydown', function(e) {
                                        if (e.key === 'Enter') {
                                            e.preventDefault();
                                            applyDateFilters();
                                        }
                                    });
                                });

                                // hide spinner initially (in case not already hidden)
                                (function(){ var s = document.getElementById('rpt_loading'); if (s) s.style.display = 'none'; })();
                            });
                            ]]></script>

                        <table class="consolidated-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">CHART OF ACCOUNT</th>
                                    <th style="width: 25%;">DESCRIPTION</th>
                                    <t t-foreach="report.get('district_headers', [])" t-as="district">
                                        <th style="width: 8%;" class="text-right"><t t-esc="district"/></th>
                                    </t>
                                    <th style="width: 10%;" class="text-right">TOTAL REV.</th>
                                    <th style="width: 10%;" class="text-right">TOTAL EXP.</th>
                                    <th style="width: 12%;" class="text-right">BALANCE</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="report.get('report_lines', [])" t-as="line">
                                    <t t-set="safe_account_code" t-value="str(line.get('code','')).replace('.','_').replace('-','_').replace(' ','_')"/>
                                    
                                    <tr class="expandable-row" style="cursor: pointer;" t-attf-onclick="toggleAccountDetails('#{safe_account_code}')">
                                        <td>
                                            <span t-attf-id="icon-#{safe_account_code}" class="expand-icon">‚ñ∂</span>
                                            <span class="account-code" t-esc="line.get('code','')"/>
                                        </td>
                                        <td><strong t-esc="line.get('description','')"/></td>
                                        <t t-foreach="range(len(report.get('district_codes', [])))" t-as="i">
                                            <t t-set="district_code" t-value="report['district_codes'][i]"/>
                                            <td class="text-right">
                                                <strong t-esc="'{:,.2f}'.format(line.get('district_values', {}).get(district_code, 0.0))"/>
                                            </td>
                                        </t>
                                        <td class="text-right"><strong t-esc="'{:,.2f}'.format(line.get('total_revenue', 0.0))"/></td>
                                        <td class="text-right"><strong t-esc="'{:,.2f}'.format(line.get('total_expenditure', 0.0))"/></td>
                                        <td class="text-right"><strong t-esc="'{:,.2f}'.format(line.get('balance', 0.0))"/></td>
                                    </tr>

                                    <t t-foreach="range(len(report.get('district_codes', [])))" t-as="i">
                                        <t t-set="district_code" t-value="report['district_codes'][i]"/>
                                        <t t-set="district_name" t-value="report['district_headers'][i]"/>
                                        <t t-set="district_moves" t-value="line.get('move_details', {}).get(district_code, [])"/>
                                        <t t-if="district_moves">
                                            <tr t-attf-class="move-detail-row moves-#{safe_account_code}" style="background-color: #e8f4f8;">
                                                <td class="indent-move" colspan="2"><strong>üìç <t t-esc="district_name"/> District Transactions:</strong></td>
                                                <td t-att-colspan="len(report.get('district_codes', [])) + 1" class="text-right">
                                                    <strong>Count: <t t-esc="len(district_moves)"/> transactions</strong>
                                                </td>
                                                <td colspan="2"/> 
                                            </tr>

                                            <t t-foreach="district_moves" t-as="move">
                                                <tr t-attf-class="move-detail-row moves-#{safe_account_code}">
                                                    <td class="indent-move"><span class="move-reference"><t t-esc="move.get('date','')"/></span></td>
                                                    <td class="indent-move">
                                                        <div><strong><t t-esc="move.get('description','')[:50]"/><t t-if="len(move.get('description','')) &gt; 50">...</t></strong></div>
                                                        <div class="move-reference">Ref: <t t-esc="move.get('reference','')"/><t t-if="move.get('partner')"> | Partner: <t t-esc="move.get('partner')"/></t></div>
                                                    </td>
                                                    <t t-foreach="report.get('district_codes', [])" t-as="other_district_code">
                                                        <td class="text-right">
                                                            <t t-if="other_district_code == district_code">
                                                                <span t-esc="'{:,.2f}'.format(move.get('balance',0.0))"/>
                                                            </t>
                                                            <t t-else="">-</t>
                                                        </td>
                                                    </t>
                                                    <td class="text-right"><span t-esc="'{:,.2f}'.format(move.get('credit',0.0))"/></td>
                                                    <td class="text-right"><span t-esc="'{:,.2f}'.format(move.get('debit',0.0))"/></td>
                                                    <td class="text-right"><span t-esc="'{:,.2f}'.format(move.get('credit',0.0) - move.get('debit',0.0))"/></td>
                                                </tr>
                                            </t>
                                        </t>
                                    </t>
                                </t>

                                <tr class="total-row">
                                    <td colspan="2"><strong>GRAND TOTAL</strong></td>
                                    <t t-foreach="report.get('district_codes', [])" t-as="district_code">
                                        <td class="text-right"><strong>
                                            <t t-set="district_total" t-value="sum([line.get('district_values', {}).get(district_code, 0.0) for line in report.get('report_lines', [])])"/>
                                            <span t-esc="'{:,.2f}'.format(district_total)"/>
                                        </strong></td>
                                    </t>
                                    <td class="text-right"><strong>
                                        <t t-set="total_revenue" t-value="sum([line.get('total_revenue', 0.0) for line in report.get('report_lines', [])])"/>
                                        <span t-esc="'{:,.2f}'.format(total_revenue)"/>
                                    </strong></td>
                                    <td class="text-right"><strong>
                                        <t t-set="total_expenditure" t-value="sum([line.get('total_expenditure', 0.0) for line in report.get('report_lines', [])])"/>
                                        <span t-esc="'{:,.2f}'.format(total_expenditure)"/>
                                    </strong></td>
                                    <td class="text-right"><strong>
                                        <span t-esc="'{:,.2f}'.format(sum([line.get('balance', 0.0) for line in report.get('report_lines', [])]))"/>
                                    </strong></td>
                                </tr>
                            </tbody>
                        </table>

                        <div style="margin-top: 20px; font-size: 9px; color: #666;">
                            <p><strong>Instructions:</strong></p>
                            <ul>
                                <li>Click on any account row (with ‚ñ∂ arrow) to expand/collapse detailed transactions</li>
                                <li>Each district's transactions are grouped separately when expanded</li>
                                <li>Transaction details include date, description, reference, and partner information</li>
                            </ul>
                        </div>
                    </div>
                </t>

                <style>
                    .company-section { page-break-after: always; }
                    .company-section:last-child { page-break-after: auto; }
                    .tag-line { font-weight:600; background:#f8f9fa; }
                    .account-line { background:#ffffff; }
                    @media print { .d-print-none { display:none !important; } }
                </style>

            </t>
        </t>
    </template>


    <template id="consolidated_district_report_pdf_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-foreach="data" t-as="report">
                    <div class="page">
                        <div class="text-center mb-4">
                            <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                                <t t-esc="report.get('company_name', 'EEDC')"/>
                            </h2>
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">
                                CONSOLIDATED DISTRICT REPORT
                            </h3>
                            <h4 style="font-size: 14px; font-weight: bold; margin-top: 0;">
                                <t t-esc="report.get('subtitle')"/>
                            </h4>
                        </div>

                        <style>
                            .pdf-consolidated-table {
                                border-collapse: collapse;
                                width: 100%;
                                font-size: 9px;
                                margin-top: 20px;
                                page-break-inside: avoid;
                            }
                            .pdf-consolidated-table th, 
                            .pdf-consolidated-table td {
                                border: 1px solid #000;
                                padding: 4px;
                                vertical-align: top;
                                word-wrap: break-word;
                            }
                            .pdf-consolidated-table th {
                                background-color: #e6e6e6;
                                font-weight: bold;
                                text-align: center;
                                font-size: 8px;
                                padding: 6px 4px;
                            }
                            .pdf-text-right {
                                text-align: right !important;
                            }
                            .pdf-text-center {
                                text-align: center !important;
                            }
                            .pdf-text-left {
                                text-align: left !important;
                            }
                            .pdf-account-row {
                                background-color: #f8f9fa;
                                font-weight: bold;
                                font-size: 9px;
                            }
                            .pdf-move-detail-row {
                                background-color: #fff;
                                font-size: 7px;
                                font-weight: normal;
                            }
                            .pdf-district-header {
                                background-color: #e8f4f8;
                                font-weight: bold;
                                font-size: 8px;
                            }
                            .pdf-total-row {
                                background-color: #d4edda;
                                font-weight: bold;
                                border-top: 2px solid #000;
                                font-size: 9px;
                            }
                            .pdf-account-code {
                                font-family: 'Courier New', monospace;
                                font-weight: bold;
                            }
                            .pdf-move-reference {
                                font-size: 6px;
                                color: #666;
                                font-style: italic;
                            }
                            .pdf-indent {
                                padding-left: 15px;
                            }
                            .pdf-indent-2 {
                                padding-left: 25px;
                            }
                            .pdf-page-break {
                                page-break-before: always;
                            }
                            .pdf-no-break {
                                page-break-inside: avoid;
                            }
                            .pdf-summary-box {
                                border: 2px solid #000;
                                padding: 10px;
                                margin-top: 20px;
                                background-color: #f0f0f0;
                            }
                            .pdf-summary-title {
                                font-weight: bold;
                                font-size: 12px;
                                text-align: center;
                                margin-bottom: 10px;
                            }
                        </style>

                        <div class="pdf-summary-box">
                            <div class="pdf-summary-title">EXECUTIVE SUMMARY</div>
                            <table style="width: 100%; font-size: 9px;">
                                <tr>
                                    <td style="width: 50%; vertical-align: top;">
                                        <strong>Report Period:</strong> <t t-esc="report.get('start_date', '')"/> to <t t-esc="report.get('end_date', '')"/><br/>
                                        <strong>Account Type:</strong> <t t-esc="report.get('account_head_type', '')"/><br/>
                                        <strong>Number of Districts:</strong> <t t-esc="len(report.get('district_headers', []))"/><br/>
                                        <strong>Number of Accounts:</strong> <t t-esc="len(report.get('report_lines', []))"/>
                                    </td>
                                    <td style="width: 50%; vertical-align: top;">
                                        <t t-set="total_revenue" t-value="sum([line.get('total_revenue', 0.0) for line in report.get('report_lines', [])])"/>
                                        <t t-set="total_expenditure" t-value="sum([line.get('total_expenditure', 0.0) for line in report.get('report_lines', [])])"/>
                                        <t t-set="net_balance" t-value="total_revenue - total_expenditure"/>
                                        <strong>Total Revenue:</strong> <span style="color: green;"><t t-esc="'{:,.2f}'.format(total_revenue)"/></span><br/>
                                        <strong>Total Expenditure:</strong> <span style="color: red;"><t t-esc="'{:,.2f}'.format(total_expenditure)"/></span><br/>
                                        <strong>Net Balance:</strong> 
                                        <span t-att-style="'color: ' + ('green' if net_balance >= 0 else 'red') + ';'">
                                            <t t-esc="'{:,.2f}'.format(net_balance)"/>
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <table class="pdf-consolidated-table">
                            <thead>
                                <tr>
                                    <th style="width: 12%;">CHART OF<br/>ACCOUNT</th>
                                    <th style="width: 20%;">DESCRIPTION</th>
                                    <t t-foreach="report.get('district_headers', [])" t-as="district">
                                        <th style="width: 6%;" class="pdf-text-right">
                                            <t t-esc="district[:8]"/>
                                        </th>
                                    </t>
                                    <th style="width: 8%;" class="pdf-text-right">TOTAL<br/>REV.</th>
                                    <th style="width: 8%;" class="pdf-text-right">TOTAL<br/>EXP.</th>
                                    <th style="width: 8%;" class="pdf-text-right">BALANCE</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="report.get('report_lines', [])" t-as="line">
                                    <tr class="pdf-account-row pdf-no-break">
                                        <td class="pdf-account-code">
                                            <t t-esc="line.get('code', '')"/>
                                        </td>
                                        <td>
                                            <strong><t t-esc="line.get('description', '')"/></strong>
                                        </td>
                                        <t t-foreach="range(len(report.get('district_codes', [])))" t-as="i">
                                            <t t-set="district_code" t-value="report['district_codes'][i]"/>
                                            <td class="pdf-text-right">
                                                <strong><t t-esc="'{:,.0f}'.format(line.get('district_values', {}).get(district_code, 0.0))"/></strong>
                                            </td>
                                        </t>
                                        <td class="pdf-text-right">
                                            <strong><t t-esc="'{:,.0f}'.format(line.get('total_revenue', 0.0))"/></strong>
                                        </td>
                                        <td class="pdf-text-right">
                                            <strong><t t-esc="'{:,.0f}'.format(line.get('total_expenditure', 0.0))"/></strong>
                                        </td>
                                        <td class="pdf-text-right">
                                            <strong><t t-esc="'{:,.0f}'.format(line.get('balance', 0.0))"/></strong>
                                        </td>
                                    </tr>

                                    <t t-set="has_transactions" t-value="False"/>
                                    <t t-foreach="range(len(report.get('district_codes', [])))" t-as="i">
                                        <t t-set="district_code" t-value="report['district_codes'][i]"/>
                                        <t t-set="district_name" t-value="report['district_headers'][i]"/>
                                        <t t-set="district_moves" t-value="line.get('move_details', {}).get(district_code, [])"/>
                                        
                                        <t t-if="district_moves">
                                            <t t-set="has_transactions" t-value="True"/>
                                            <tr class="pdf-district-header">
                                                <td class="pdf-indent">üìç</td>
                                                <td class="pdf-indent">
                                                    <strong><t t-esc="district_name"/> District (<t t-esc="len(district_moves)"/> transactions)</strong>
                                                </td>
                                                <td t-att-colspan="len(report.get('district_codes', [])) + 3" class="pdf-text-right">
                                                    <strong>District Total: <t t-esc="'{:,.0f}'.format(line.get('district_values', {}).get(district_code, 0.0))"/></strong>
                                                </td>
                                            </tr>
                                            
                                            <t t-foreach="district_moves[:5]" t-as="move">
                                                <tr class="pdf-move-detail-row">
                                                    <td class="pdf-indent-2">
                                                        <span class="pdf-move-reference"><t t-esc="move.get('date', '')"/></span>
                                                    </td>
                                                    <td class="pdf-indent-2">
                                                        <div style="font-size: 7px; line-height: 1.2;">
                                                            <strong><t t-esc="move.get('description', '')[:40]"/><t t-if="len(move.get('description', '')) > 40">...</t></strong><br/>
                                                            <span class="pdf-move-reference">
                                                                <t t-esc="move.get('reference', '')"/>
                                                                <t t-if="move.get('partner')"> | <t t-esc="move.get('partner', '')[:15]"/></t>
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <t t-foreach="report.get('district_codes', [])" t-as="other_district_code">
                                                        <td class="pdf-text-right">
                                                            <t t-if="other_district_code == district_code">
                                                                <t t-esc="'{:,.0f}'.format(move.get('balance', 0.0))"/>
                                                            </t>
                                                            <t t-else="">-</t>
                                                        </td>
                                                    </t>
                                                    <td class="pdf-text-right"><t t-esc="'{:,.0f}'.format(move.get('credit', 0.0))"/></td>
                                                    <td class="pdf-text-right"><t t-esc="'{:,.0f}'.format(move.get('debit', 0.0))"/></td>
                                                    <td class="pdf-text-right"><t t-esc="'{:,.0f}'.format(move.get('credit', 0.0) - move.get('debit', 0.0))"/></td>
                                                </tr>
                                            </t>
                                            
                                            <t t-if="len(district_moves) > 5">
                                                <tr class="pdf-move-detail-row" style="font-style: italic; color: #666;">
                                                    <td class="pdf-indent-2" colspan="2">
                                                        ... and <t t-esc="len(district_moves) - 5"/> more transactions
                                                    </td>
                                                    <td t-att-colspan="len(report.get('district_codes', [])) + 3"/>
                                                </tr>
                                            </t>
                                        </t>
                                    </t>
                                    
                                    <t t-if="has_transactions">
                                        <tr>
                                            <td colspan="100%" style="border-bottom: 2px solid #ccc; padding: 2px;"></td>
                                        </tr>
                                    </t>
                                </t>
                                
                                <tr class="pdf-total-row">
                                    <td colspan="2"><strong>GRAND TOTAL</strong></td>
                                    <t t-foreach="report.get('district_codes', [])" t-as="district_code">
                                        <td class="pdf-text-right">
                                            <strong>
                                                <t t-set="district_total" t-value="sum([line.get('district_values', {}).get(district_code, 0.0) for line in report.get('report_lines', [])])"/>
                                                <t t-esc="'{:,.0f}'.format(district_total)"/>
                                            </strong>
                                        </td>
                                    </t>
                                    <td class="pdf-text-right">
                                        <strong>
                                            <t t-set="total_revenue" t-value="sum([line.get('total_revenue', 0.0) for line in report.get('report_lines', [])])"/>
                                            <t t-esc="'{:,.0f}'.format(total_revenue)"/>
                                        </strong>
                                    </td>
                                    <td class="pdf-text-right">
                                        <strong>
                                            <t t-set="total_expenditure" t-value="sum([line.get('total_expenditure', 0.0) for line in report.get('report_lines', [])])"/>
                                            <t t-esc="'{:,.0f}'.format(total_expenditure)"/>
                                        </strong>
                                    </td>
                                    <td class="pdf-text-right">
                                        <strong>
                                            <t t-esc="'{:,.0f}'.format(sum([line.get('balance', 0.0) for line in report.get('report_lines', [])]))"/>
                                        </strong>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div style="margin-top: 15px; font-size: 8px; color: #666;">
                            <p><strong>Report Notes:</strong></p>
                            <ul style="margin: 5px 0; padding-left: 15px;">
                                <li>This report shows consolidated financial data across all selected districts</li>
                                <li>Transaction details are limited to the top 5 transactions per district per account for PDF brevity</li>
                                <li>All amounts are displayed in the company's base currency</li>
                                <li>Generated on: <t t-esc="context_timestamp(datetime.datetime.now()).strftime('%Y-%m-%d %H:%M:%S')"/></li>
                            </ul>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>

        <record id="action_report_expenditure_monthly" model="ir.actions.report">
            <field name="name">Monthly Expenditure Report</field>
            <field name="model">account.dynamic.report</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">eedc_report.report_expenditure_monthly_template</field>
            <field name="report_file">eedc_report.report_expenditure_monthly_template</field>
        <!-- <field name="paperformat_id" ref="eedc_report.paperformat_report_monthly_expenditure"/> -->
        </record>
        
        <record id="action_report_expenditure_quarterly" model="ir.actions.report">
            <field name="name">Quarterly Expenditure Report</field>
            <field name="model">account.dynamic.report</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">eedc_report.report_expenditure_quarterly_template</field>
            <field name="report_file">eedc_report.report_expenditure_quarterly_template</field>
            <field name="binding_model_id" eval="False"/>
        </record>

        <record id="action_consolidated_district_report" model="ir.actions.report">
            <field name="name">Consolidated District Report</field>
            <field name="model">account.dynamic.report</field>
            <field name="report_type">qweb-html</field>
            <field name="report_name">eedc_report.consolidated_district_report_template</field>
            <field name="report_file">eedc_report.consolidated_district_report_template</field>
            <field name="binding_model_id" ref="model_account_dynamic_report"/>
            <field name="binding_type">report</field>
        </record>

        <record id="action_consolidated_district_report_pdf" model="ir.actions.report">
            <field name="name">Consolidated District Report (PDF)</field>
            <field name="model">account.dynamic.report</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">eedc_report.consolidated_district_report_pdf_template</field>
            <field name="report_file">eedc_report.consolidated_district_report_pdf_template</field>
            <field name="binding_model_id" ref="model_account_dynamic_report"/>
            <field name="binding_type">report</field>
            <field name="paperformat_id" ref="base.paperformat_euro"/>
        </record>

        <record id="action_report_capital_monthly" model="ir.actions.report">
            <field name="name">Monthly Capital Report</field>
            <field name="model">account.dynamic.report</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">eedc_report.report_capital_monthly_template</field>
            <field name="report_file">eedc_report.report_capital_monthly_template</field>
        </record>

        <record id="action_report_capital_quarterly" model="ir.actions.report">
            <field name="name">Quarterly Capital Report</field>
            <field name="model">account.dynamic.report</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">eedc_report.report_capital_quarterly_template</field>
            <field name="report_file">eedc_report.report_capital_quarterly_template</field>
            <field name="binding_model_id" eval="False"/>
        </record>
</odoo>
