<?xml version="1.0" encoding="utf-8"?>
<templates>
  <!-- Column template (themed via [data-stage] in SCSS) -->
  <t t-name="tm.Column">
    <div class="col-12 col-md-6 col-xl-3">
      <div class="tm-col card h-100" t-att-data-stage="stage.key">
        <div class="tm-stage-header card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <span class="tm-dot" t-att-class="'stage-'+stage.key"/>
            <strong t-esc="stage.title"/>
          </div>
          <span class="tm-count badge" t-esc="stage.count"/>
        </div>

        <div class="card-body tm-col-body" t-att-id="'tm_col_'+stage.key">
          <!-- <div class="tm-empty text-muted">Nothing here yet</div> -->
          <div class="tm-empty text-muted">
            <div class="tm-empty-text">Nothing here yet</div>
          </div>
          <t t-foreach="cards" t-as="c">
            <t t-call="tm.Card">
              <t t-set="card" t-value="c"/>
            </t>
          </t>
        </div>

      </div>
    </div>
  </t>

  <!-- Card template: title+priority (top), description+due (middle), tags (bottom) -->
  <t t-name="tm.Card">
    <div class="tm-card card mb-2" t-att-data-id="card.id" draggable="true">
      <div class="card-body p-3 d-flex flex-column gap-2">
       
        <!-- Top: title + priority pill (no wrapping, ellipsis) + view more(3-dot button) -->
        <div class="tm-card-top d-flex align-items-start gap-2">
          <div class="tm-card-title flex-grow-1" t-att-title="card.name" t-esc="card.name"/>
          <span t-attf-class="badge rounded-pill tm-priority prio-#{card.priority}">
            <t t-if="card.priority=='2'">High</t>
            <t t-if="card.priority=='1'">Medium</t>
            <t t-if="card.priority=='0'">Low</t>
          </span>
          <button class="btn btn-sm btn-light tm-more" title="View more">
            <i class="fa fa-ellipsis-v"/>
          </button>
        </div>

        <!-- Middle: description + due date (stacked) -->
        <div class="tm-card-middle">
          <div class="tm-card-desc tm-desc" t-if="card.description" t-esc="card.description"/>
          <div class="tm-due small mt-1 text-muted" t-if="card.due_date" t-att-data-due="card.due_date">
            <i class="fa fa-clock-o me-1"/>
            <t t-esc="card.due_date"/>
          </div>
        </div>

        <!-- Bottom: tags -->
        <div class="tm-card-bottom small tm-tags" t-if="card.tags and card.tags.length">
          <t t-foreach="card.tags" t-as="tg">
            <span class="tm-chip badge rounded-pill me-1 mb-1" t-esc="tg"/>
          </t>
        </div>
      </div>
    </div>
  </t>

  <!-- Modal template -->
  <t t-name="tm.TaskModal">
    <div class="modal fade tm-modal" id="tmTaskModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <!-- Header -->
          <div class="modal-header align-items-start">
            <div class="d-flex flex-column">
              <h5 class="modal-title mb-1"><t t-esc="task.name"/></h5>
              <div class="tm-meta small d-flex flex-wrap gap-2 align-items-center">
                <span t-attf-class="badge rounded-pill tm-priority prio-#{task.priority}">
                  <t t-esc="task.priority_label"/>
                </span>
                <t t-if="task.due_date">
                  <span class="text-muted"><i class="fa fa-clock-o me-1"/> <t t-esc="task.due_date"/></span>
                </t>
                <t t-if="task.tags and task.tags.length">
                  <span class="text-muted">•</span>
                  <t t-foreach="task.tags" t-as="tg">
                    <span class="badge rounded-pill tm-chip" t-esc="tg"/>
                  </t>
                </t>
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"/>
          </div>

          <!-- Body -->
          <div class="modal-body">
            <!-- Description -->
            <div class="tm-section">
              <p class="tm-full-desc mb-0" t-esc="task.description or 'No description.'"/>
            </div>

          <!-- Comments -->
          <div class="tm-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0">Comments</h6>
              <small class="text-muted" id="tm_chat_hint">Newest at bottom</small>
            </div>

            <div id="tm_chat_list" class="tm-chat-list">
              <t t-set="__last_day" t-value="''"/>
              <t t-foreach="messages" t-as="m">
                <!-- Day separator -->
                <t t-if="m.day_label and m.day_label != __last_day">
                  <div class="tm-day-sep"><span t-esc="m.day_label"/></div>
                  <t t-set="__last_day" t-value="m.day_label"/>
                </t>
                <!-- Message bubble -->
                <div t-attf-class="tm-chat-item #{m.kind == 'system' and 'tm-system' or ''}">
                  <t t-if="m.kind != 'system'">
                    <div class="tm-avatar" t-att-title="m.author"><t t-esc="m.initials"/></div>
                  </t>
                  <div class="tm-bubble">
                    <div class="tm-bubble-head" t-if="m.kind != 'system'">
                      <span class="tm-author"><t t-esc="m.author"/></span>
                      <span class="tm-date text-muted"><t t-esc="m.date"/></span>
                    </div>
                    <div class="tm-bubble-body" t-if="m.kind == 'comment'" t-raw="m.body"/>
                    <div class="tm-bubble-body tm-system-body" t-if="m.kind == 'system'"><t t-esc="m.body"/></div>

                    <!-- Attachments -->
                    <!-- attachments with image preview -->
                    <t t-if="m.attachments &amp;&amp; m.attachments.length">
                      <div class="tm-attachments mt-2">
                        <t t-foreach="m.attachments" t-as="att">
                          <t t-set="isImage" t-value="(att.mimetype || '').indexOf('image/') === 0"/>
                          <t t-if="isImage">
                            <a class="tm-thumb" t-attf-href="/web/content/#{att.id}" target="_blank">
                              <img t-attf-src="/web/image/#{att.id}" t-att-alt="att.name"/>
                            </a>
                          </t>
                          <t t-else="">
                            <a class="tm-attachment" t-attf-href="/web/content/#{att.id}?download=1" target="_blank">
                              <i class="fa fa-paperclip me-1"/>
                              <t t-esc="att.name"/>
                            </a>
                          </t>
                        </t>
                      </div>
                    </t>
                  </div>
                </div>
              </t>
            </div>
          </div>

          <!-- Simple in-modal image viewer -->
          <div class="tm-img-viewer d-none" id="tm_img_viewer">
            <button type="button" class="tm-img-close" aria-label="Close">×</button>
            <img id="tm_img_full" src="" alt="preview"/>
          </div>

            <!-- Composer -->
            <div class="tm-section">
              <div class="tm-composer">
                <div class="tm-dropzone" id="tm_dropzone">
                  <textarea id="tm_chat_text" class="form-control" rows="3" placeholder="Write a comment…"></textarea>
                  <div id="tm_attach_preview" class="tm-attach-preview"></div>
                </div>
                <div class="tm-composer-actions">
                  <input type="file" id="tm_chat_files" class="d-none" multiple/>
                  <button class="btn btn-light tm-attach-btn" type="button" id="tm_attach_btn" title="Attach files">
                    <i class="fa fa-paperclip"/>
                  </button>
                  <button class="btn btn-primary tm-chat-send" type="button">Send</button>
                </div>
              </div>
              <small class="text-muted d-block mt-1">Tip: drag &amp; drop files into the box above.</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </t>
</templates>